# bot.py ‚Äî Channel-based verification (no DMs) + Nickname Setup Cog
from __future__ import annotations

import os
from typing import Optional, Dict

import discord
from discord.ext import commands
from dotenv import load_dotenv

# -------- Load configuration --------
load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")
GUILD_ID = int(os.getenv("GUILD_ID", "0"))
VERIFIED_ROLE_NAME = os.getenv("VERIFIED_ROLE", "Verified")
VERIFY_PASSWORD = os.getenv("VERIFY_PASSWORD", "secret123")
VERIFY_CHANNEL_NAME = os.getenv("VERIFY_CHANNEL", "verify")  # channel where flow happens
MAX_ATTEMPTS = int(os.getenv("VERIFY_ATTEMPTS", "3"))

if not TOKEN:
    raise SystemExit("DISCORD_TOKEN is missing.")

# -------- Bot setup --------
intents = discord.Intents.default()
intents.members = True
intents.message_content = True

bot = commands.Bot(command_prefix="!", intents=intents, help_command=None)

# Track who is in a verification session (user_id -> attempts_left)
pending_sessions: Dict[int, int] = {}


# -------- Helpers --------
async def ensure_verified_role(guild: discord.Guild) -> discord.Role:
    role = discord.utils.get(guild.roles, name=VERIFIED_ROLE_NAME)
    if role:
        return role
    # Create role if missing
    return await guild.create_role(name=VERIFIED_ROLE_NAME, mentionable=True, reason="Create verified role")


async def add_verified(member: discord.Member) -> None:
    role = await ensure_verified_role(member.guild)
    await member.add_roles(role, reason="Verification passed")


def is_verify_channel(channel: discord.abc.GuildChannel) -> bool:
    return isinstance(channel, discord.TextChannel) and channel.name.lower() == VERIFY_CHANNEL_NAME.lower()


# -------- Events --------
@bot.event
async def on_ready():
    print(f"‚úÖ Logged in as {bot.user} (ID: {bot.user.id})")
    print(f"‚ÑπÔ∏è Guild: {GUILD_ID or 'auto'} | Verify channel: #{VERIFY_CHANNEL_NAME} | Role: {VERIFIED_ROLE_NAME}")


@bot.event
async def on_member_join(member: discord.Member):
    # Optional: Nudge newcomer in-channel if verify channel exists
    channel = discord.utils.get(member.guild.text_channels, name=VERIFY_CHANNEL_NAME)
    if channel:
        try:
            await channel.send(f"Welcome {member.mention}! Type **verify** to start verification.")
        except discord.Forbidden:
            pass


@bot.event
async def on_message(message: discord.Message):
    # Ignore bot messages
    if message.author.bot:
        return

    # Only handle inside the verify channel
    if not is_verify_channel(message.channel):
        await bot.process_commands(message)
        return

    guild: Optional[discord.Guild] = message.guild
    if not guild:
        await bot.process_commands(message)
        return

    # If user already has the verified role, ignore
    verified_role = discord.utils.get(guild.roles, name=VERIFIED_ROLE_NAME)
    if verified_role and isinstance(message.author, discord.Member) and verified_role in message.author.roles:
        await message.add_reaction("‚úÖ")
        await bot.process_commands(message)
        return

    content = message.content.strip()

    # 1) User types the trigger word "verify"
    if content.lower() == "verify":
        pending_sessions[message.author.id] = MAX_ATTEMPTS
        await message.reply(
            "Please enter the **password** to verify.\n"
            f"You have **{MAX_ATTEMPTS}** attempts.",
            mention_author=True
        )
        return

    # 2) If user is in a session, treat next messages as password attempts
    if message.author.id in pending_sessions:
        # Try to delete the user's password message for privacy
        try:
            await message.delete()
        except discord.Forbidden:
            pass
        except discord.HTTPException:
            pass

        attempts_left = pending_sessions.get(message.author.id, MAX_ATTEMPTS)

        if content == VERIFY_PASSWORD:
            try:
                member = guild.get_member(message.author.id)
                if not member:
                    await message.channel.send("I couldn't find your member record. Please re-join the server.")
                    return
                await add_verified(member)
                await message.channel.send(f"{message.author.mention} ‚úÖ Verified! Welcome üéâ")
            except discord.Forbidden:
                await message.channel.send(
                    f"{message.author.mention} ‚ö†Ô∏è I can't assign roles. Please ask an admin to move my role **above** `{VERIFIED_ROLE_NAME}`."
                )
            finally:
                pending_sessions.pop(message.author.id, None)
            return
        else:
            attempts_left -= 1
            if attempts_left <= 0:
                pending_sessions.pop(message.author.id, None)
                await message.channel.send(f"{message.author.mention} ‚ùå Incorrect password. No attempts left. Please contact a moderator.")
            else:
                pending_sessions[message.author.id] = attempts_left
                await message.channel.send(
                    f"{message.author.mention} ‚ùå Incorrect password. Attempts left: **{attempts_left}**.\n"
                    "Type the password again."
                )
            return

    # If none of the above and user typed something else, lightly guide them
    if content and content.lower() != "verify":
        await message.reply("Type **verify** to start verification.", mention_author=True)

    await bot.process_commands(message)


# -------- Simple health command --------
@bot.command(name="ping")
async def ping(ctx: commands.Context):
    await ctx.reply("Pong!", mention_author=False)


# ========= Nickname Setup (Additive Cog) =========
# ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ™ÿπŸäŸäŸÜ: user_id -> {"stage": "ask_name"/"ask_team", "name": str}
# ÿßÿ≥ÿ™ÿÆÿØŸÖŸÜÿß dict ÿßŸÑŸÖÿØŸÖÿ¨ ŸÑÿ™ŸÅÿßÿØŸä ŸÖÿ¥ÿßŸÉŸÑ typing
pending_nickname_sessions: dict[int, dict[str, str]] = {}

class NicknameSetup(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot

    # ÿπŸÜÿØŸÖÿß ÿßŸÑÿπÿ∂Ÿà ÿ™Ÿèÿ∂ÿßŸÅ ŸÑŸá ÿ±ÿ™ÿ®ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸëŸÇÿå ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿØŸÅŸëŸÇ
    @commands.Cog.listener()
    async def on_member_update(self, before: "discord.Member", after: "discord.Member"):
        # ŸÜÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿ±ÿ™ÿ®ÿ© VERIFIED_ROLE_NAME ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß ÿßŸÑÿ¢ŸÜ
        if before.guild is None or after.guild is None:
            return

        added_roles = set(after.roles) - set(before.roles)
        if not added_roles:
            return

        verified_role = discord.utils.get(after.guild.roles, name=VERIFIED_ROLE_NAME)
        if verified_role and verified_role in added_roles:
            # ÿßÿ®ÿØÿ£ ÿ¨ŸÑÿ≥ÿ© ÿ¨ŸÖÿπ ÿßŸÑÿßÿ≥ŸÖ/ÿßŸÑŸÅÿ±ŸäŸÇ
            pending_nickname_sessions[after.id] = {"stage": "ask_name", "name": ""}
            channel = discord.utils.get(after.guild.text_channels, name=VERIFY_CHANNEL_NAME)
            if channel:
                try:
                    await channel.send(
                        f"{after.mention} ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸëŸÇ ‚úÖ\n"
                        "ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ÿ∏ŸáŸàÿ±Ÿá ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± (ÿ®ÿØŸàŸÜ ŸÅÿ±ŸäŸÇ)."
                    )
                except discord.Forbidden:
                    pass

    # ÿ™ÿßÿ®ÿπ ÿßŸÑÿ™ÿØŸÅŸëŸÇ ÿ®ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿØÿßÿÆŸÑ ŸÇŸÜÿßÿ© #verify
    @commands.Cog.listener()
    async def on_message(self, message: "discord.Message"):
        # ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ®Ÿàÿ™ÿßÿ™
        if message.author.bot:
            return
        # ŸÅŸÇÿ∑ ÿØÿßÿÆŸÑ ŸÇŸÜÿßÿ© ÿßŸÑÿ™ÿ≠ŸÇŸëŸÇ
        if not is_verify_channel(message.channel):
            return

        user_id = message.author.id
        session = pending_nickname_sessions.get(user_id)

        # ÿ£ŸÖÿ± ŸäÿØŸàŸä ŸÑÿ®ÿØÿ° ÿßŸÑÿ™ÿØŸÅŸëŸÇ ÿ•ŸÜ ÿßÿ≠ÿ™ÿßÿ¨
        if message.content.strip().lower().startswith("!setnick"):
            pending_nickname_sessions[user_id] = {"stage": "ask_name", "name": ""}
            await message.reply("ÿßÿ®ÿØÿ£ÿå ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ (ÿ®ÿØŸàŸÜ ŸÅÿ±ŸäŸÇ).", mention_author=True)
            return

        if not session:
            return  # ŸÑÿß ÿ¨ŸÑÿ≥ÿ© ÿ≠ÿßŸÑŸäÿ©

        stage = session["stage"]
        content = message.content.strip()

        # ÿ≠ÿßŸàŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑÿ™ŸÇŸÑŸäŸÑ ŸÖŸÜ ÿßŸÑÿ∂Ÿàÿ∂ÿßÿ° (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
        try:
            await message.delete()
        except (discord.Forbidden, discord.HTTPException):
            pass

        # ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 1: ÿßŸÑÿßÿ≥ŸÖ
        if stage == "ask_name":
            base_name = content.replace("@", "").strip()
            if not base_name:
                await message.channel.send(
                    f"{message.author.mention} ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿµÿßŸÑÿ≠."
                )
                return

            pending_nickname_sessions[user_id]["name"] = base_name
            pending_nickname_sessions[user_id]["stage"] = "ask_team"
            await message.channel.send(
                f"{message.author.mention} ÿ™ŸÖÿßŸÖ! ÿßŸÑÿ¢ŸÜ ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ŸäŸÇ."
            )
            return

        # ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 2: ÿßŸÑŸÅÿ±ŸäŸÇ
        if stage == "ask_team":
            team = content.replace("@", "").strip()
            if not team:
                await message.channel.send(
                    f"{message.author.mention} ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÅÿ±ŸäŸÇ ÿµÿßŸÑÿ≠."
                )
                return

            # ÿ¨ŸáŸëÿ≤ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÜŸáÿßÿ¶Ÿä
            final_nick = f"{pending_nickname_sessions[user_id]['name']}-{team}"

            # ŸÇÿµŸë ÿπŸÑŸâ 32 ŸÖÿ≠ÿ±ŸÅ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± (ÿ≠ÿØ ÿØŸäÿ≥ŸÉŸàÿ±ÿØ)
            if len(final_nick) > 32:
                name_part, team_part = pending_nickname_sessions[user_id]['name'], team
                max_total = 32
                # ÿßÿ™ÿ±ŸÉ 1 ŸÑŸÑÿ¥ÿ±ÿ∑ÿ©
                half = (max_total - 1) // 2
                name_part = (name_part[:half]).rstrip()
                team_part = (team_part[:max_total - 1 - len(name_part)]).rstrip()
                final_nick = f"{name_part}-{team_part}"
                # ÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ÿßŸÑŸÅÿ±ÿßÿ∫
                if not name_part or not team_part:
                    final_nick = final_nick[:32].rstrip("-")

            # ŸÜŸÅŸëÿ∞ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±
            guild = message.guild
            member = guild.get_member(user_id) if guild else None
            if not member:
                await message.channel.send(
                    f"{message.author.mention} ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ≠ÿ≥ÿßÿ®ŸÉ. ÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØŸãÿß."
                )
                pending_nickname_sessions.pop(user_id, None)
                return

            try:
                await member.edit(nick=final_nick, reason="Nickname setup: Name-Team")
                await message.channel.send(
                    f"{message.author.mention} ÿ™ŸÖ ÿ∂ÿ®ÿ∑ ÿßÿ≥ŸÖŸÉ: **{final_nick}** ‚úÖ"
                )
            except discord.Forbidden:
                await message.channel.send(
                    f"{message.author.mention} ‚ö†Ô∏è ŸÑÿß ÿ£ÿ≥ÿ™ÿ∑Ÿäÿπ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ±ÿ©. "
                    "ÿ±ÿ¨ÿßÿ°Ÿã ÿßÿ±ŸÅÿπ ÿ±ÿ™ÿ®ÿ© ÿßŸÑÿ®Ÿàÿ™ ŸÅŸàŸÇ ÿßŸÑÿ£ÿπÿ∂ÿßÿ° Ÿàÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ **Manage Nicknames**."
                )
            except discord.HTTPException:
                await message.channel.send(
                    f"{message.author.mention} ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ."
                )
            finally:
                # ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ©
                pending_nickname_sessions.pop(user_id, None)

# ÿ≥ÿ¨ŸëŸÑ ÿßŸÑŸÄ Cog
bot.add_cog(NicknameSetup(bot))
# ========= End Nickname Setup =========


if __name__ == "__main__":
    bot.run(TOKEN)
